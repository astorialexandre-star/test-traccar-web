<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Navettes - 369 Shuttles</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; height: 100vh; background: #f4f4f4; }
        #map { width: 100%; height: 100%; z-index: 1; }
        
        /* S√©lecteur de Ligne Unique et Discret */
        .header-ui {
            position: absolute; top: 15px; left: 50%; transform: translateX(-50%);
            z-index: 1000; width: 90%; max-width: 400px;
        }
        .line-picker {
            background: white; padding: 5px; border-radius: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2); border: 1px solid rgba(0,0,0,0.1);
        }
        select {
            width: 100%; border: none; background: transparent; padding: 10px 15px;
            font-size: 15px; font-weight: 600; color: #005587; outline: none; appearance: none;
            text-align: center; cursor: pointer;
        }

        /* Animation pour la navette s√©lectionn√©e */
        .shuttle-icon { transition: all 0.3s ease; }
        .focused-shuttle {
            border: 3px solid #2ecc71 !important; /* Vert pour indiquer le suivi */
            box-shadow: 0 0 15px rgba(46, 204, 113, 0.6) !important;
            transform: scale(1.2);
        }

        .info-toast {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.7); color: white; padding: 8px 15px;
            border-radius: 20px; font-size: 12px; z-index: 1000; pointer-events: none;
            display: none;
        }
    </style>
</head>
<body>

    <div class="header-ui">
        <div class="line-picker">
            <select id="line-select" onchange="handleLineChange()">
                <option value="">üìç Afficher toutes les navettes</option>
                <option value="1">Ligne 1 : Le Village</option>
                <option value="2">Ligne 2 : Mont d'Arbois</option>
                <option value="3">Ligne 3 : C√¥te 2000</option>
            </select>
        </div>
    </div>

    <div id="status-toast" class="info-toast">Suivi automatique activ√©</div>
    <div id="map"></div>

    <script>
        const TRACCAR_URL = 'https://369shuttles.duckdns.org';
        const AUTH = 'Basic ' + btoa('lobby@hotel.local:Hotel2026!');
        
        const map = L.map('map', { zoomControl: false }).setView([45.8590, 6.6285], 15);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

        let fleetMarkers = {};
        let selectedLineId = null;
        let focusedShuttleId = null;
        let isUserDragging = false;

        // D√©tection du mouvement manuel pour stopper le focus
        map.on('movestart', () => { if(!isInternalMove) focusedShuttleId = null; document.getElementById('status-toast').style.display='none'; });
        let isInternalMove = false;

        function handleLineChange() {
            selectedLineId = document.getElementById('line-select').value;
            focusedShuttleId = null;
            updateMap();
        }

        async function updateMap() {
            try {
                const [resDev, resPos] = await Promise.all([
                    fetch(`${TRACCAR_URL}/api/devices`, { headers: { 'Authorization': AUTH } }),
                    fetch(`${TRACCAR_URL}/api/positions`, { headers: { 'Authorization': AUTH } })
                ]);
                const devices = await resDev.json();
                const positions = await resPos.json();

                devices.forEach(dev => {
                    const pos = positions.find(p => p.deviceId === dev.id);
                    const isVisibleOnLine = !selectedLineId || dev.groupId == selectedLineId;
                    const isPublic = !dev.attributes.hideClient;

                    if (pos && isVisibleOnLine && isPublic) {
                        const isFocused = dev.id == focusedShuttleId;
                        
                        if (!fleetMarkers[dev.id]) {
                            fleetMarkers[dev.id] = L.marker([pos.latitude, pos.longitude]).addTo(map);
                            // AU CLIC : On d√©finit le focus
                            fleetMarkers[dev.id].on('click', () => {
                                focusedShuttleId = dev.id;
                                document.getElementById('status-toast').style.display='block';
                                document.getElementById('status-toast').innerText = `Suivi de : ${dev.name}`;
                                map.flyTo([pos.latitude, pos.longitude], 17);
                            });
                        }
                        
                        fleetMarkers[dev.id].setLatLng([pos.latitude, pos.longitude]);
                        
                        // Style de l'ic√¥ne (Normal vs Focus)
                        const focusClass = isFocused ? 'focused-shuttle' : '';
                        fleetMarkers[dev.id].setIcon(L.divIcon({
                            html: `<div class="shuttle-icon ${focusClass}" style="width:40px;height:40px;background:white;border:3px solid #005587;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 10px rgba(0,0,0,0.2)"><img src="images/van.png" style="width:25px;"></div>`,
                            className: '', iconSize:[40,40], iconAnchor:[20,20]
                        }));

                        // Suivi dynamique
                        if (isFocused) {
                            isInternalMove = true;
                            map.panTo([pos.latitude, pos.longitude]);
                            setTimeout(() => { isInternalMove = false; }, 100);
                        }
                    } else {
                        if (fleetMarkers[dev.id]) {
                            map.removeLayer(fleetMarkers[dev.id]);
                            delete fleetMarkers[dev.id];
                        }
                    }
                });
            } catch (e) { console.error(e); }
        }

        // Remettre ici votre bloc L.geoJSON du trac√© original pour qu'il soit visible
        const circuitData = {"type":"FeatureCollection","features":[/* ... vos donn√©es GeoJSON ... */]};
        L.geoJSON(circuitData, { style: { color: '#005587', weight: 6, opacity: 0.2 } }).addTo(map);

        setInterval(updateMap, 4000);
        updateMap();
    </script>
</body>
</html>

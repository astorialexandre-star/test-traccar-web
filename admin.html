<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>ADMIN - Supervision 369 Shuttles</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root { 
            --bg: #f4f7f6; --primary: #2c3e50; --accent: #3498db; 
            --success: #27ae60; --danger: #e74c3c; --warning: #f1c40f;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        h1 { color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 10px; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        
        .card { 
            background: white; border-radius: 12px; padding: 20px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-left: 8px solid #ccc;
            transition: transform 0.2s;
        }
        .card.active { border-left-color: var(--success); }
        .card.hidden { border-left-color: var(--danger); opacity: 0.8; }

        .shuttle-name { font-size: 22px; font-weight: bold; margin-bottom: 10px; display: flex; justify-content: space-between; }
        .status-badge { font-size: 12px; padding: 4px 8px; border-radius: 12px; text-transform: uppercase; }
        .bg-online { background: #d4edda; color: #155724; }
        .bg-offline { background: #f8d7da; color: #721c24; }

        .info-row { margin: 8px 0; font-size: 15px; display: flex; align-items: center; }
        .info-icon { width: 25px; margin-right: 10px; text-align: center; }
        
        .driver-msg { 
            background: #fdf6e3; border: 1px solid #eee8d5; padding: 10px; 
            border-radius: 8px; margin-top: 15px; font-weight: bold; color: #b58900;
            text-align: center; font-size: 16px;
        }
        
        .refresh-bar { font-size: 12px; color: #666; margin-top: 10px; text-align: right; }
    </style>
</head>
<body>

    <h1>Tableau de Bord - Supervision Navettes</h1>
    <div id="shuttle-container" class="grid">
        </div>
    <div class="refresh-bar" id="last-update">Mise Ã  jour : --:--:--</div>

    <script>
        const TRACCAR_URL = 'https://369shuttles.duckdns.org';
        const AUTH = 'Basic ' + btoa('lobby@hotel.local:Hotel2026!');

        async function updateAdminDashboard() {
            try {
                // 1. RÃ©cupÃ©rer les appareils
                const devRes = await fetch(`${TRACCAR_URL}/api/devices`, { headers: { 'Authorization': AUTH } });
                const devices = await devRes.json();

                // 2. RÃ©cupÃ©rer les positions
                const posRes = await fetch(`${TRACCAR_URL}/api/positions`, { headers: { 'Authorization': AUTH } });
                const positions = await posRes.json();

                const container = document.getElementById('shuttle-container');
                
                devices.forEach(device => {
                    const pos = positions.find(p => p.deviceId === device.id);
                    if (!pos) return;

                    let card = document.getElementById(`card-${device.id}`);
                    if (!card) {
                        card = document.createElement('div');
                        card.id = `card-${device.id}`;
                        card.className = 'card';
                        container.appendChild(card);
                    }

                    // Logique d'Ã©tat
                    const isHidden = device.attributes.hideClient === true;
                    const speed = Math.round(pos.speed * 1.852);
                    const battery = pos.attributes.batteryLevel || device.attributes.batteryLevel || '--';
                    const driverStatus = device.attributes.driverStatus || 'En service';
                    const lastUpdate = new Date(pos.deviceTime).toLocaleTimeString('fr-FR');

                    card.className = `card ${isHidden ? 'hidden' : 'active'}`;
                    
                    card.innerHTML = `
                        <div class="shuttle-name">
                            ${device.name}
                            <span class="status-badge ${isHidden ? 'bg-offline' : 'bg-online'}">
                                ${isHidden ? 'MasquÃ© (Client)' : 'Visible'}
                            </span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-icon">â›½</span> 
                            <span>Batterie : <b>${battery}%</b></span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-icon">ðŸš€</span> 
                            <span>Vitesse : <b>${speed} km/h</b></span>
                        </div>

                        <div class="info-row">
                            <span class="info-icon">ðŸ•’</span> 
                            <span>Dernier signal : ${lastUpdate}</span>
                        </div>

                        <div class="driver-msg">
                            ðŸ“¢ STATUT : ${driverStatus}
                        </div>
                    `;
                });

                document.getElementById('last-update').innerText = "DerniÃ¨re mise Ã  jour : " + new Date().toLocaleTimeString('fr-FR');

            } catch (error) {
                console.error("Erreur de mise Ã  jour admin:", error);
            }
        }

        // Mise Ã  jour toutes les 5 secondes
        setInterval(updateAdminDashboard, 5000);
        updateAdminDashboard();
    </script>
</body>
</html>

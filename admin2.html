<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>ADMIN - Supervision Totale 369 Shuttles</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root { --primary: #005587; --success: #2ecc71; --danger: #e74c3c; --dark: #1a1a1a; }
        body { margin: 0; padding: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; background: #f4f7f6; display: flex; flex-direction: column; height: 100vh; }
        
        #admin-header { padding: 15px; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 1000; overflow-y: auto; max-height: 40vh; }
        .shuttle-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
        .shuttle-card { background: #fff; border-radius: 12px; padding: 12px; border: 2px solid #eee; display: flex; flex-direction: column; gap: 8px; transition: all 0.3s; }
        .shuttle-card.active { border-color: var(--success); box-shadow: 0 4px 12px rgba(46, 204, 113, 0.15); }
        .shuttle-card.hidden { border-color: #ccc; opacity: 0.7; background: #fafafa; }
        
        .card-top { display: flex; justify-content: space-between; align-items: center; }
        .shuttle-name { font-weight: bold; color: var(--primary); font-size: 15px; }
        .driver-name { color: #555; font-size: 14px; }
        .driver-status { background: #fdf6e3; color: #b58900; padding: 5px 10px; border-radius: 8px; font-size: 13px; font-weight: bold; text-align: center; border: 1px solid #eee8d5; }
        
        #map { flex-grow: 1; width: 100%; z-index: 1; }

        .switch { position: relative; width: 46px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        input:checked + .slider { background-color: var(--success); }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider:before { transform: translateX(22px); }

        .bus-circle { width: 38px; height: 38px; background: white; border-radius: 50%; border: 3px solid var(--primary); display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
        .bus-circle img { width: 24px !important; height: 24px !important; }

        #pin-overlay, .manager-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--dark); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .manager-overlay { background: rgba(0,0,0,0.85); display: none; }
        
        .manager-container { background: white; color: #333; width: 90%; max-width: 500px; padding: 20px; border-radius: 15px; position: relative; }
        .close-btn { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #666; }

        .map-btns { position: absolute; bottom: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
        .btn-round { width: 50px; height: 50px; border-radius: 50%; background: white; border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.3); cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; }

        .keypad { display: grid; grid-template-columns: repeat(3, 75px); gap: 15px; }
        .key { width: 75px; height: 75px; background: #333; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; -webkit-tap-highlight-color: transparent; }
        
        .tab-btn { padding: 10px; border: none; background: #eee; cursor: pointer; flex: 1; font-weight: bold; }
        .tab-btn.active { background: var(--primary); color: white; }
        .driver-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; align-items: center; }
    </style>
</head>
<body>

    <div id="pin-overlay">
        <h2 style="font-weight: 300; margin-bottom:10px;">SUPERVISION ADMIN</h2>
        <div id="pin-display" style="font-size:32px; letter-spacing:8px; color:var(--success); min-height:40px; margin-bottom:20px;"></div>
        <div class="keypad">
            <div class="key" onclick="press('1')">1</div><div class="key" onclick="press('2')">2</div><div class="key" onclick="press('3')">3</div>
            <div class="key" onclick="press('4')">4</div><div class="key" onclick="press('5')">5</div><div class="key" onclick="press('6')">6</div>
            <div class="key" onclick="press('7')">7</div><div class="key" onclick="press('8')">8</div><div class="key" onclick="press('9')">9</div>
            <div class="key" style="color:var(--danger)" onclick="press('C')">C</div><div class="key" onclick="press('0')">0</div><div class="key" style="color:var(--success)" onclick="press('OK')">OK</div>
        </div>
    </div>

    <div id="manager-overlay" class="manager-overlay">
        <div class="manager-container">
            <span class="close-btn" onclick="toggleManager(false)">&times;</span>
            <div style="display:flex; margin-bottom:15px; border-radius:8px; overflow:hidden;">
                <button id="tab-drivers" class="tab-btn active" onclick="switchTab('drivers')">Conducteurs</button>
                <button id="tab-fleet" class="tab-btn" onclick="switchTab('fleet')">Flotte</button>
            </div>
            <div id="manager-content" style="max-height: 350px; overflow-y: auto;"></div>
        </div>
    </div>

    <div id="admin-header">
        <div class="shuttle-grid" id="shuttle-list"></div>
    </div>

    <div id="map"></div>
    
    <div class="map-btns">
        <button class="btn-round" title="Gestion" onclick="toggleManager(true)">‚öôÔ∏è</button>
        <button class="btn-round" title="Effacer les traces" onclick="clearTracks()">üóëÔ∏è</button>
    </div>

    <script>
        const PIN_SECRET = "3690";
        let currentPin = "";
        const TRACCAR_URL = 'https://369shuttles.duckdns.org'; 
        const AUTH = 'Basic ' + btoa('lobby@hotel.local:Hotel2026!');

        let fleetData = {};
        let currentTab = 'drivers';

        const map = L.map('map', { zoomControl: false }).setView([45.8590, 6.6285], 15);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

        // --- CIRCUIT & HOTELS ---
        const circuitData = {"type":"FeatureCollection","features":[{"type":"Feature","geometry":{"type":"LineString","coordinates":[[6.629327,45.859227],[6.629352,45.859139],[6.629369,45.859059],[6.629361,45.858970],[6.629314,45.858899],[6.629255,45.858843],[6.629153,45.858796],[6.629030,45.858754],[6.628877,45.858692],[6.628690,45.858619],[6.628461,45.858521],[6.628291,45.858447],[6.628192,45.858403],[6.628052,45.858371],[6.627895,45.858341],[6.627708,45.858306],[6.627564,45.858276],[6.627428,45.858238],[6.627330,45.858181],[6.627224,45.858134],[6.627135,45.858081],[6.627004,45.858048],[6.626842,45.858051],[6.626753,45.858102],[6.626707,45.858187],[6.626766,45.858261],[6.626889,45.858353],[6.627059,45.858492],[6.627190,45.858595],[6.627313,45.858707],[6.627398,45.858778],[6.627564,45.858894],[6.627747,45.858956],[6.627937,45.859003],[6.628044,45.859062],[6.628073,45.859151],[6.627982,45.859270],[6.627848,45.859299],[6.627689,45.859269],[6.627551,45.859234]]}},{"type":"Feature","geometry":{"type":"LineString","coordinates":[[6.627548,45.859232],[6.627420,45.859201],[6.627136,45.859131],[6.626844,45.858992],[6.626603,45.858758],[6.626276,45.858611],[6.626118,45.858680],[6.626159,45.858863],[6.626514,45.859240],[6.626854,45.859639],[6.627108,45.859871],[6.627349,45.860312],[6.627438,45.860869],[6.627041,45.860568],[6.626224,45.860300],[6.626028,45.860097],[6.625535,45.859664],[6.625089,45.859361],[6.624640,45.859091],[6.624190,45.858753],[6.623778,45.858472]]}},{"type":"Feature","geometry":{"type":"LineString","coordinates":[[6.623778,45.858472],[6.623050,45.858262],[6.622379,45.858004],[6.621634,45.857747],[6.620984,45.857615],[6.620851,45.857641],[6.620729,45.857588],[6.620748,45.857562],[6.620658,45.857497],[6.620737,45.857529],[6.620898,45.857593],[6.620970,45.857613]]}},{"type":"Feature","geometry":{"type":"LineString","coordinates":[[6.631599,45.853848],[6.631526,45.854377],[6.631436,45.855170],[6.631368,45.855894],[6.631256,45.856669],[6.631171,45.857162],[6.631103,45.857644],[6.631126,45.858208],[6.631247,45.858865],[6.631296,45.859061]]}},{"type":"Feature","geometry":{"type":"LineString","coordinates":[[6.631295,45.859061],[6.631196,45.859342],[6.630607,45.859949],[6.630039,45.860571],[6.630101,45.860843],[6.630560,45.861179],[6.631005,45.861818],[6.631160,45.862401],[6.631349,45.862799],[6.631745,45.863157],[6.632047,45.863829],[6.632563,45.864357],[6.632827,45.864952],[6.633118,45.865281],[6.633651,45.865602],[6.633606,45.865833],[6.632256,45.865130],[6.631747,45.864633],[6.631235,45.864068],[6.630441,45.863589],[6.629704,45.863008],[6.629313,45.862561],[6.629117,45.862146],[6.628441,45.861607],[6.627921,45.861233],[6.627438,45.860869]]}}]}
        L.geoJSON(circuitData, { style: { color: '#3388ff', weight: 6, opacity: 0.4 } }).addTo(map);

        const hotels = [
            { name: "Mamie", icon: "images/logomamiemegeve.png", coords: [45.8593, 6.6291] },
            { name: "Arbois", icon: "images/logomontdarbois.png", coords: [45.8538, 6.6317] },
            { name: "Arboisie", icon: "images/logolarboisie.png", coords: [45.8586, 6.6276] },
            { name: "Village", icon: "images/logovillage.png", coords: [45.8575, 6.6206] }
        ];

        hotels.forEach(h => L.marker(h.coords, { icon: L.icon({ iconUrl: h.icon, iconSize: [60, 60], iconAnchor: [30, 60] }) }).addTo(map));

        // --- PIN LOGIC ---
        function press(k) {
            if (k === 'C') currentPin = "";
            else if (k === 'OK') {
                if (currentPin === PIN_SECRET) document.getElementById('pin-overlay').style.display='none';
                else { alert("PIN incorrect"); currentPin=""; }
            } else if (currentPin.length < 4) currentPin += k;
            document.getElementById('pin-display').innerText = "‚Ä¢".repeat(currentPin.length);
        }

        // --- GESTION (TABS) ---
        function toggleManager(show) {
            document.getElementById('manager-overlay').style.display = show ? 'flex' : 'none';
            if(show) switchTab(currentTab);
        }

        function switchTab(tab) {
            currentTab = tab;
            document.getElementById('tab-drivers').className = 'tab-btn' + (tab==='drivers'?' active':'');
            document.getElementById('tab-fleet').className = 'tab-btn' + (tab==='fleet'?' active':'');
            if(tab === 'drivers') renderDrivers(); else renderFleet();
        }

        async function renderDrivers() {
            const res = await fetch(`${TRACCAR_URL}/api/drivers`, { headers: { 'Authorization': AUTH } });
            const drivers = await res.json();
            let html = `<div style="display:flex; gap:5px; margin-bottom:15px;"><input id="in-n" placeholder="Nom"><input id="in-p" placeholder="PIN" style="width:60px"><button onclick="apiDriver('POST')" style="background:var(--success); color:white; border:none; padding:10px;">+</button></div>`;
            drivers.forEach(d => html += `<div class="driver-row"><span>${d.name} (${d.uniqueId})</span><button onclick="apiDriver('DELETE', ${d.id})" style="color:var(--danger); border:none; background:none; cursor:pointer">üóëÔ∏è</button></div>`);
            document.getElementById('manager-content').innerHTML = html;
        }

        async function renderFleet() {
            const res = await fetch(`${TRACCAR_URL}/api/devices`, { headers: { 'Authorization': AUTH } });
            const devices = await res.json();
            let html = `<p style="font-size:12px; color:#666">Appareils d√©clar√©s sur Traccar :</p>`;
            devices.forEach(d => html += `<div class="driver-row"><span>üöê ${d.name}</span><span style="color:${d.status==='online'?'green':'red'}">${d.status}</span></div>`);
            document.getElementById('manager-content').innerHTML = html;
        }

        async function apiDriver(method, id) {
            const name = document.getElementById('in-n')?.value;
            const pin = document.getElementById('in-p')?.value;
            const url = id ? `${TRACCAR_URL}/api/drivers/${id}` : `${TRACCAR_URL}/api/drivers`;
            await fetch(url, { method: method, headers: { 'Authorization': AUTH, 'Content-Type': 'application/json' }, body: method==='POST'?JSON.stringify({name:name, uniqueId:pin}):null });
            renderDrivers();
        }

        // --- SUPERVISION (MAIN LOOP) ---
        async function updateAdmin() {
            try {
                const devRes = await fetch(`${TRACCAR_URL}/api/devices`, { headers: { 'Authorization': AUTH } });
                const devices = await devRes.json();
                const list = document.getElementById('shuttle-list');
                
                devices.forEach(dev => {
                    if (!fleetData[dev.id]) fleetData[dev.id] = { history: [], marker: null, polyline: null, color: (dev.id % 2 === 0 ? '#2ecc71' : '#e67e22') };
                    
                    const f = fleetData[dev.id];
                    const active = !dev.attributes.hideClient;
                    const driver = dev.attributes.currentDriver || "Libre";
                    const status = dev.attributes.driverStatus || (active ? "En service" : "Hors service");

                    let card = document.getElementById(`card-${dev.id}`);
                    if (!card) { card = document.createElement('div'); card.id = `card-${dev.id}`; list.appendChild(card); }

                    card.className = `shuttle-card ${active ? 'active' : 'hidden'}`;
                    card.innerHTML = `
                        <div class="card-top">
                            <div><span class="shuttle-name">${dev.name}</span><br><span class="driver-name">üë§ ${driver}</span></div>
                            <label class="switch">
                                <input type="checkbox" ${active ? 'checked' : ''} onchange="toggleDev(${dev.id}, this.checked)">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="driver-status">üì¢ ${status}</div>
                        <div style="font-size:11px; color:#666;" id="stats-${dev.id}">...</div>
                    `;
                    updatePosition(dev.id, active);
                });
            } catch(e) {}
        }

        async function updatePosition(id, active) {
            try {
                const res = await fetch(`${TRACCAR_URL}/api/positions?deviceId=${id}`, { headers: { 'Authorization': AUTH } });
                const pos = await res.json();
                if (pos.length > 0) {
                    const p = pos[0];
                    const f = fleetData[id];
                    const speed = Math.round(p.speed * 1.852);
                    const latlng = [p.latitude, p.longitude];
                    
                    document.getElementById(`stats-${id}`).innerText = `üîã ${p.attributes.batteryLevel || '--'}% | ${speed} km/h`;

                    if (f.history.length === 0 || map.distance(f.history[f.history.length-1], latlng) > 30) {
                        f.history.push(latlng);
                        if (f.history.length > 30) f.history.shift();
                        if (f.polyline) f.polyline.setLatLngs(f.history);
                        else f.polyline = L.polyline(f.history, {color: f.color, weight: 3, opacity: 0.5, dashArray: '5,10'}).addTo(map);
                    }

                    if (!f.marker) f.marker = L.marker(latlng, { icon: L.divIcon({ html: `<div class="bus-circle" style="border-color:${f.color}"><img src="images/van.png"></div>`, className: '', iconSize:[40,40], iconAnchor:[20,20] }) }).addTo(map);
                    else f.marker.setLatLng(latlng);

                    f.marker.setOpacity(active ? 1 : 0.2);
                    if (f.polyline) f.polyline.setStyle({ opacity: active ? 0.5 : 0.05 });
                }
            } catch(e) {}
        }

        async function toggleDev(id, val) {
            const res = await fetch(`${TRACCAR_URL}/api/devices?id=${id}`, { headers: { 'Authorization': AUTH } });
            const devs = await res.json();
            const d = devs[0];
            d.attributes.hideClient = !val;
            d.attributes.driverStatus = val ? "En service" : "Hors service";
            await fetch(`${TRACCAR_URL}/api/devices/${id}`, { method: 'PUT', headers: { 'Authorization': AUTH, 'Content-Type': 'application/json' }, body: JSON.stringify(d) });
            updateAdmin();
        }

        function clearTracks() { Object.values(fleetData).forEach(f => { f.history = []; if(f.polyline) f.polyline.setLatLngs([]); }); }

        setInterval(updateAdmin, 4000);
        updateAdmin();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>DEMO - Suivi Fluide Navettes</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-marker-slide-to@latest/dist/Leaflet.Marker.SlideTo.js"></script>
    
    <style>
        :root { --primary: #005587; --l1: #3498db; --l2: #9b59b6; }
        body { margin: 0; padding: 0; font-family: sans-serif; }
        #map { height: 100vh; width: 100%; }
        
        .navette-container { position: relative; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; }
        .bus-circle { width: 34px; height: 34px; background: white; border-radius: 50%; border: 3px solid var(--primary); display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .bus-circle img { width: 20px; }
        .direction-arrow { position: absolute; width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-bottom: 10px solid var(--primary); top: -12px; transition: transform 0.4s ease; }
        
        .demo-overlay { position: absolute; top: 20px; left: 20px; z-index: 1000; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); max-width: 250px; }
    </style>
</head>
<body>

    <div class="demo-overlay">
        <h3 style="margin:0 0 10px 0">Mode Démo</h3>
        <p style="font-size: 12px; color: #666;">Les navettes simulent un trajet toutes les 4 secondes avec une transition fluide de 3 secondes via <b>slideTo</b>.</p>
        <div id="status" style="font-weight: bold; color: green;">Simulation active</div>
    </div>

    <div id="map"></div>

    <script>
        // Initialisation de la carte sur Megève
        const map = L.map('map', { zoomControl: false }).setView([45.8590, 6.6285], 15);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

        // Stockage des navettes factices
        let shuttles = {};
        
        // Données de départ pour la simulation
        const fakeDevices = [
            { id: 101, name: "Navette A", color: "#3498db", lat: 45.8590, lng: 6.6285 },
            { id: 102, name: "Navette B", color: "#9b59b6", lat: 45.8540, lng: 6.6310 }
        ];

        function updateFakePositions() {
            fakeDevices.forEach(dev => {
                // On simule un petit déplacement aléatoire
                dev.lat += (Math.random() - 0.5) * 0.002;
                dev.lng += (Math.random() - 0.5) * 0.002;
                
                const latlng = [dev.lat, dev.lng];
                const angle = Math.floor(Math.random() * 360); // Angle aléatoire pour la flèche

                const html = `
                    <div class="navette-container">
                        <div class="direction-arrow" style="transform: rotate(${angle}deg); border-bottom-color: ${dev.color}"></div>
                        <div class="bus-circle" style="border-color: ${dev.color}">
                            <img src="https://cdn-icons-png.flaticon.com/512/3448/3448339.png"> 
                        </div>
                    </div>`;

                if (!shuttles[dev.id]) {
                    // Création initiale
                    shuttles[dev.id] = L.marker(latlng, {
                        icon: L.divIcon({ html: html, className: '', iconSize: [44, 44], iconAnchor: [22, 22] })
                    }).addTo(map);
                } else {
                    // TEST DU SLIDETO
                    // On déplace le marqueur sur 3000ms (3 secondes)
                    shuttles[dev.id].slideTo(latlng, { duration: 3000 });
                    
                    // On met à jour l'icône (pour la rotation de la flèche)
                    shuttles[dev.id].setIcon(L.divIcon({ 
                        html: html, 
                        className: '', 
                        iconSize: [44, 44], 
                        iconAnchor: [22, 22] 
                    }));
                }
            });
        }

        // Lancement de la simulation
        updateFakePositions(); // Premier affichage
        setInterval(updateFakePositions, 4000); // Mise à jour toutes les 4s
    </script>
</body>
</html>

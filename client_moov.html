<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>DEMO ULTRA-ROBUSTE - 369 Shuttles</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        #map { height: 100vh; width: 100%; }
        .navette-container { position: relative; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; }
        .bus-circle { width: 34px; height: 34px; background: white; border-radius: 50%; border: 3px solid #005587; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.3); overflow: hidden; }
        .bus-circle img { width: 22px !important; height: 22px !important; object-fit: contain; }
    </style>
</head>
<body>

    <div id="map"></div>

    <script>
        /* --- CODE DU PLUGIN INTEGRÉ POUR ÉVITER LES ERREURS DE CHARGEMENT --- */
        (function(){var t=L.Marker.prototype.setLatLng;L.Marker.include({slideTo:function(e,i){if(this._map){this._slideFromLatLng=this.getLatLng(),this._slideToLatLng=L.latLng(e),this._slideDuration=i.duration,this._slideKeepAtCenter=!!i.keepAtCenter,this._slideStartTime=Date.now(),this._slide();return this}},_slide:function(){if(this._map){var e=(Date.now()-this._slideStartTime)/this._slideDuration;if(e>=1){this.setLatLng(this._slideToLatLng),this.fire("moveend");return}var i=L.latLng(this._slideFromLatLng.lat+(this._slideToLatLng.lat-this._slideFromLatLng.lat)*e,this._slideFromLatLng.lng+(this._slideToLatLng.lng-this._slideFromLatLng.lng)*e);this.setLatLng(i),this._slideKeepAtCenter&&this._map.panTo(i),L.Util.requestAnimFrame(this._slide,this)}}})})();
        /* --- FIN DU PLUGIN --- */

        // Initialisation Carte
        const map = L.map('map').setView([45.8590, 6.6285], 16);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

        // Création du bus
        const icon = L.divIcon({ 
            html: '<div class="navette-container"><div class="bus-circle"><img src="https://cdn-icons-png.flaticon.com/512/3448/3448339.png"></div></div>', 
            className: '', iconSize: [44, 44], iconAnchor: [22, 22] 
        });
        const shuttle = L.marker([45.8590, 6.6285], { icon: icon }).addTo(map);

        // Simulation de mouvement
        function simulate() {
            const nextPos = [
                45.8590 + (Math.random() - 0.5) * 0.006,
                6.6285 + (Math.random() - 0.5) * 0.006
            ];
            // On fait glisser le bus pendant 3.5 secondes
            shuttle.slideTo(nextPos, { duration: 3500 });
        }

        setInterval(simulate, 4000);
        simulate();
    </script>
</body>
</html>

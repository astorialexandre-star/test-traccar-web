<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Diagnostic Connexion - 369 Shuttles</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 30px; background: #f0f2f5; }
        .container { max-width: 700px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        h2 { color: #005587; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .log-box { background: #1e1e1e; color: #00ff00; padding: 15px; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 13px; max-height: 300px; overflow-y: auto; margin-top: 20px; }
        .status-pill { display: inline-block; padding: 5px 12px; border-radius: 20px; font-weight: bold; font-size: 12px; margin-top: 10px; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e9; color: #2e7d32; }
        button { background: #005587; color: white; border: none; padding: 12px 25px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        button:hover { background: #003d61; }
    </style>
</head>
<body>

<div class="container">
    <h2>ðŸ“¡ Test de Liaison Serveur</h2>
    <p>Tentative de connexion Ã  : <strong>https://369shuttles.duckdns.org</strong></p>
    
    <button onclick="runDiagnostic()">DÃ©marrer le Diagnostic</button>
    
    <div id="status-display"></div>
    <div class="log-box" id="log-output">PrÃªt pour le test...</div>
</div>

<script>
    // Votre Token de session
    const TOKEN = "RzBFAiAV9oRBhhgG76CjxJUjHYwOwhANdC0I5WViTRs1BU5nCgIhAOD1PHmWj6IDODkuoKXxuQ3D8u7AdMHJB-Ifn0uGji24eyJpIjo4Nzk0MDQwNzcwNTg0MTA0OTAxLCJ1IjoxLCJlIjoiMjAyNi0wMi0wM1QyMzowMDowMC4wMDArMDA6MDAifQ";
    const API_BASE = "https://369shuttles.duckdns.org/api";

    async function runDiagnostic() {
        const log = document.getElementById('log-output');
        const status = document.getElementById('status-display');
        log.innerHTML = "Ã‰tape 1 : Envoi de la requÃªte avec Header Authorization...\n";

        try {
            const response = await fetch(`${API_BASE}/devices`, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    // On teste l'autorisation par Bearer Token
                    'Authorization': `Bearer ${TOKEN}`
                }
            });

            if (response.status === 401) {
                log.innerHTML += "ERREUR 401 : Le serveur a rejetÃ© le Token.\n";
                log.innerHTML += "Tentative de repli (Format alternatif : ?token=)...\n";
                
                // Tentative de secours avec le token en paramÃ¨tre d'URL
                const retryResponse = await fetch(`${API_BASE}/devices?token=${TOKEN}`);
                if (retryResponse.ok) {
                    processData(await retryResponse.json());
                } else {
                    showError("Ã‰chec des deux mÃ©thodes. VÃ©rifiez si le Token est expirÃ© ou si le CORS est activÃ©.");
                }
            } else if (response.ok) {
                processData(await response.json());
            } else {
                showError(`Erreur serveur : ${response.status}`);
            }

        } catch (err) {
            showError("Erreur rÃ©seau : Impossible de contacter le serveur (VÃ©rifiez le CORS ou l'URL).");
        }
    }

    function processData(data) {
        const log = document.getElementById('log-output');
        const status = document.getElementById('status-display');
        status.innerHTML = `<span class="status-pill success">CONNEXION Ã‰TABLIE</span>`;
        log.innerHTML += `SUCCÃˆS : ${data.length} appareil(s) trouvÃ©(s).\n\n`;
        log.innerHTML += JSON.stringify(data, null, 2);
    }

    function showError(msg) {
        const status = document.getElementById('status-display');
        const log = document.getElementById('log-output');
        status.innerHTML = `<span class="status-pill error">Ã‰CHEC</span>`;
        log.innerHTML += `ERREUR : ${msg}\n`;
    }
</script>

</body>
</html>

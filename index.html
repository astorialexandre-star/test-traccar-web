<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Tracking 369 Shuttles</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        #map { height: 100vh; width: 100%; background: #e5e3df; }
        
        .status-header { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 1000; background: white; padding: 10px 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); width: 85%; max-width: 400px; text-align: center; }
        
        .shuttle-switcher { position: absolute; top: 65px; left: 50%; transform: translateX(-50%); z-index: 1000; display: flex; gap: 5px; background: rgba(255,255,255,0.95); padding: 5px; border-radius: 50px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 90%; overflow-x: auto; }
        .sw-btn { padding: 8px 15px; border-radius: 40px; border: none; font-size: 11px; font-weight: bold; cursor: pointer; background: transparent; color: #666; white-space: nowrap; }
        .sw-btn.active { background: #005587; color: white; }

        .map-controls { position: absolute; bottom: 30px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 15px; }
        .ctrl-btn { width: 55px; height: 55px; border-radius: 50%; background: white; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.2); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.3s; padding: 10px; }
        .ctrl-btn img { width: 32px; height: 32px; }
        .ctrl-btn.active { background: #005587; }
        .ctrl-btn.active img { filter: brightness(0) invert(1); } 

        .navette-container { position: relative; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }
        .navette-label { background: #005587; color: white; padding: 2px 8px; border-radius: 10px; font-size: 10px; position: absolute; top: -22px; white-space: nowrap; font-weight: bold; }
        .bus-circle { width: 34px; height: 34px; background: white; border-radius: 50%; border: 3px solid #005587; display: flex; align-items: center; justify-content: center; }
        .bus-circle img { width: 22px; height: 22px; display: block; } 
        
        .user-dot { width: 14px; height: 14px; background: #2196F3; border: 3px solid white; border-radius: 50%; box-shadow: 0 0 10px rgba(0,0,0,0.3); }
    </style>
</head>
<body>
    <div class="status-header"><b>DIRECT</b> <span id="current-time">--:--</span></div>
    <div class="shuttle-switcher" id="switcher"></div>
    
    <div class="map-controls">
        <button class="ctrl-btn" id="btn-user" onclick="toggleFollow('user')">
            <img src="https://cdn-icons-png.flaticon.com/512/684/684908.png" alt="Position">
        </button>
        <button class="ctrl-btn active" id="btn-shuttle" onclick="toggleFollow('shuttle')">
            <img src="https://cdn-icons-png.flaticon.com/512/3503/3503934.png" alt="Focus">
        </button>
    </div>

    <div id="map"></div>

    <script>
        const TRACCAR_URL = 'https://369shuttles.duckdns.org'; 
        const AUTH = 'Basic ' + btoa('lobby@hotel.local:Hotel2026!');
        
        const hotels = [
            { "name": "Mamie Megève", "coords": [45.8593, 6.6291], "icon": "images/logomamiemegeve.png" },
            { "name": "Mont d'Arbois", "coords": [45.8538, 6.6317], "icon": "images/logomontdarbois.png" },
            { "name": "L'Arboisie", "coords": [45.8586, 6.6276], "icon": "images/logolarboisie.png" },
            { "name": "Village", "coords": [45.8575, 6.6206], "icon": "images/logovillage.png" }
        ];

        let shuttles = {}; 
        let followId = null; 
        let userMarker = null;
        let mode = 'shuttle'; 

        const map = L.map('map', { zoomControl: false }).setView([45.8590, 6.6285], 15);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

        // --- NOUVEAU TRACÉ HAUTE PRÉCISION ---
        const circuitData = {
          "type": "FeatureCollection",
          "features": [
            { "type": "Feature", "geometry": { "type": "LineString", "coordinates": [[6.620556,45.857464],[6.620586,45.857471],[6.62073,45.85752],[6.620753,45.857547],[6.62078,45.857536],[6.620782,45.857536],[6.620814,45.857533],[6.620846,45.857539],[6.620867,45.85755],[6.620872,45.857553],[6.620888,45.857573],[6.620891,45.857596],[6.620937,45.857606],[6.620983,45.857616],[6.621038,45.857627],[6.620983,45.857616],[6.620937,45.857606],[6.620891,45.857596],[6.620882,45.857618],[6.620862,45.857636],[6.620833,45.857647],[6.620786,45.85765],[6.620743,45.857629],[6.620727,45.857609],[6.620724,45.857587],[6.620733,45.857565],[6.620753,45.857547],[6.62073,45.85752],[6.620586,45.857471],[6.620518,45.857456],[6.620586,45.857471],[6.62073,45.85752],[6.620753,45.857547],[6.620782,45.857536],[6.620814,45.857533],[6.620846,45.857539],[6.620872,45.857553],[6.620888,45.857573],[6.620891,45.857596],[6.620937,45.857606],[6.620983,45.857616],[6.621083,45.857636],[6.621212,45.857663],[6.621746,45.857775],[6.621847,45.857797],[6.622082,45.857887],[6.622367,45.857997],[6.62257,45.858077],[6.623061,45.858267],[6.623792,45.858476],[6.62396,45.858583],[6.624058,45.858646],[6.624165,45.858731],[6.624215,45.858771],[6.624682,45.859127],[6.624866,45.859245],[6.62504,45.859337],[6.625215,45.859434],[6.625538,45.859661],[6.625574,45.859692],[6.626033,45.860099],[6.626277,45.860222],[6.626631,45.860302],[6.626798,45.860389],[6.627352,45.860803],[6.627445,45.860873],[6.627448,45.860876],[6.627465,45.86089],[6.627503,45.860919],[6.628006,45.861303],[6.628167,45.861425],[6.628573,45.861693],[6.628876,45.861872],[6.629086,45.862104],[6.629135,45.862177],[6.629224,45.862311],[6.629357,45.862691],[6.629489,45.862843],[6.630057,45.863287],[6.630096,45.863317],[6.630294,45.863472],[6.630366,45.863529],[6.630454,45.863598],[6.63116,45.863993],[6.631167,45.863997],[6.632007,45.864925],[6.632996,45.865774],[6.633193,45.86585],[6.633315,45.865882],[6.633417,45.865885],[6.633508,45.865865],[6.633619,45.865824],[6.63367,45.865777],[6.633691,45.865723],[6.633695,45.86567],[6.633665,45.865619],[6.633419,45.865441],[6.633129,45.865287],[6.63305,45.865187],[6.632824,45.864946],[6.632655,45.864446],[6.632423,45.864232],[6.632097,45.863988],[6.632035,45.863794],[6.631984,45.863481],[6.631942,45.863378],[6.631892,45.863299],[6.631761,45.863175],[6.63149,45.862944],[6.631347,45.862808],[6.631248,45.862714],[6.631186,45.862623],[6.631176,45.862563],[6.631162,45.862476],[6.63116,45.862243],[6.631118,45.862054],[6.631004,45.861814],[6.630919,45.861662],[6.63076,45.861384],[6.630719,45.861314],[6.630457,45.861112],[6.630162,45.860897],[6.630052,45.860795],[6.630018,45.860694],[6.630036,45.860592],[6.630082,45.860479],[6.630155,45.860388],[6.630312,45.860228],[6.630523,45.860035],[6.630564,45.859997],[6.630643,45.859925],[6.630707,45.859858],[6.631201,45.859335],[6.631241,45.859274],[6.631276,45.859196],[6.631293,45.85906],[6.631279,45.858974],[6.631207,45.858713],[6.631144,45.85835],[6.631117,45.858075],[6.631102,45.857929],[6.631104,45.857785],[6.631107,45.857591],[6.631152,45.857263],[6.631217,45.856928],[6.63128,45.856501],[6.631305,45.856342],[6.63138,45.855791],[6.631425,45.85531],[6.631444,45.855072],[6.631495,45.85471],[6.631508,45.854576],[6.631511,45.85454],[6.63154,45.854219],[6.631547,45.85417],[6.631549,45.854163],[6.631752,45.854178],[6.63177,45.854179]] } },
            { "type": "Feature", "geometry": { "type": "LineString", "coordinates": [[6.629324,45.859218],[6.629361,45.859131],[6.629361,45.85896],[6.629251,45.858839],[6.628998,45.858751],[6.628143,45.858382],[6.627536,45.858268],[6.627352,45.858202],[6.627147,45.858082],[6.627028,45.858051],[6.626939,45.858043],[6.626851,45.858052],[6.626796,45.858075],[6.626743,45.858112],[6.626713,45.858168],[6.626725,45.85822],[6.62677,45.858277],[6.626998,45.858433],[6.627002,45.858437],[6.627442,45.858813],[6.627513,45.858861],[6.627573,45.858896],[6.627697,45.858945],[6.627827,45.858982],[6.627949,45.859008],[6.628009,45.859039],[6.628044,45.859068],[6.628066,45.859108],[6.628076,45.859149],[6.628035,45.859235],[6.627986,45.859267],[6.627934,45.859283],[6.62788,45.859297],[6.627808,45.859294],[6.627057,45.859111],[6.626902,45.859036],[6.626798,45.858962],[6.626496,45.858657],[6.626424,45.858621],[6.626322,45.858608],[6.626227,45.858615],[6.626152,45.85865],[6.626108,45.8587],[6.626102,45.858762],[6.626123,45.85881],[6.626164,45.858875],[6.626219,45.85894],[6.626358,45.858978],[6.62662,45.859358],[6.626829,45.859613],[6.626927,45.859731],[6.627009,45.859796],[6.627283,45.860007],[6.627427,45.86067],[6.627445,45.86083],[6.627445,45.860873],[6.627443,45.860871]] } },
            { "type": "Feature", "geometry": { "type": "LineString", "coordinates": [[6.628092,45.858847],[6.628007,45.858828],[6.627732,45.858799],[6.627673,45.85878],[6.627556,45.858745],[6.627405,45.858654],[6.627126,45.858444],[6.627061,45.858414],[6.626998,45.858433]] } }
          ]
        };
        L.geoJSON(circuitData, { style: { color: '#005587', weight: 4, opacity: 0.5 } }).addTo(map);

        // --- ARRÊTS ---
        hotels.forEach(h => { 
            L.marker(h.coords, { icon: L.icon({ iconUrl: h.icon, iconSize: [50, 50], iconAnchor: [25, 50] }) }).addTo(map); 
        });

        function selectShuttle(id) {
            followId = id;
            mode = 'shuttle';
            updateUI();
            updatePositions();
        }

        function toggleFollow(newMode) {
            mode = (mode === newMode) ? 'none' : newMode;
            if(mode === 'user' && userMarker) map.panTo(userMarker.getLatLng());
            updateUI();
        }

        function updateUI() {
            document.getElementById('btn-user').className = 'ctrl-btn' + (mode === 'user' ? ' active' : '');
            document.getElementById('btn-shuttle').className = 'ctrl-btn' + (mode === 'shuttle' ? ' active' : '');
        }

        async function updatePositions() {
            try {
                const [resDev, resPos] = await Promise.all([
                    fetch(`${TRACCAR_URL}/api/devices`, { headers: { 'Authorization': AUTH } }),
                    fetch(`${TRACCAR_URL}/api/positions`, { headers: { 'Authorization': AUTH } })
                ]);
                const devices = await resDev.json();
                const positions = await resPos.json();
                const activeDevices = devices.filter(d => !d.attributes.hideClient);
                
                if (!followId && activeDevices.length > 0) followId = activeDevices[0].id;

                let switcherHtml = "";
                activeDevices.forEach(dev => {
                    const pos = positions.find(p => p.deviceId === dev.id);
                    switcherHtml += `<button class="sw-btn ${followId===dev.id?'active':''}" onclick="selectShuttle(${dev.id})">${dev.name.toUpperCase()}</button>`;
                    
                    if (pos) {
                        const latlng = [pos.latitude, pos.longitude];
                        if (!shuttles[dev.id]) shuttles[dev.id] = L.marker(latlng).addTo(map);
                        shuttles[dev.id].setLatLng(latlng);
                        
                        shuttles[dev.id].setIcon(L.divIcon({ 
                            html: `<div class="navette-container"><div class="navette-label">${dev.name}</div><div class="bus-circle"><img src="images/van.png"></div></div>`, 
                            className: '', iconSize: [40, 40], iconAnchor: [20, 20] 
                        }));
                        
                        if (followId === dev.id && mode === 'shuttle') map.panTo(latlng);
                    }
                });
                document.getElementById('switcher').innerHTML = switcherHtml;
            } catch (e) {}
        }

        map.on('locationfound', (e) => {
            if (!userMarker) userMarker = L.marker(e.latlng, { icon: L.divIcon({ className: 'user-dot' }) }).addTo(map);
            else userMarker.setLatLng(e.latlng);
            if (mode === 'user') map.panTo(e.latlng);
        });

        map.locate({watch: true, enableHighAccuracy: true});
        setInterval(updatePositions, 4000);
        updatePositions();
        setInterval(() => { document.getElementById('current-time').innerText = new Date().toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'}); }, 1000);
    </script>
</body>
</html>

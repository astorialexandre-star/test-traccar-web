<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Live Map - Navette Megève</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        #map { height: 100vh; width: 100%; }
        body { margin: 0; padding: 0; overflow: hidden; background-color: #f4f4f4; }
        
        .leaflet-marker-icon {
            transition: transform 1.5s linear, left 1.5s linear, top 1.5s linear;
        }

        .navette-label {
            background: rgba(44, 62, 80, 0.9);
            color: white; border: 1px solid white; border-radius: 4px;
            padding: 2px 8px; font-size: 12px; font-weight: bold;
            text-align: center; box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        .status-header {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%); 
            z-index: 1000; background: rgba(255,255,255,0.95); 
            padding: 10px 15px; border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
            font-family: sans-serif; display: flex; flex-direction: column; align-items: center;
            width: 90%; max-width: 550px; text-align: center;
        }
        .status-top { display: flex; align-items: center; width: 100%; justify-content: center; margin-bottom: 4px; gap: 10px; }
        .status-time { font-size: 18px; font-weight: bold; color: #2c3e50; min-width: 60px; }
        .status-date { font-size: 11px; text-transform: uppercase; opacity: 0.7; color: #2c3e50; }
        #weather-box { display: flex; align-items: center; border-left: 1px solid #ddd; padding-left: 10px; margin-left: 5px; }
        #weather-temp { font-weight: bold; font-size: 16px; color: #2c3e50; }
        #weather-icon { width: 28px; height: 28px; margin-left: 5px; }

        .status-sub-header {
            position: absolute; top: 80px; left: 50%; transform: translateX(-50%); 
            z-index: 1000; background: rgba(255,255,255,0.9); 
            padding: 5px 15px; border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            font-family: sans-serif; font-size: 13px; font-weight: bold;
            width: auto; min-width: 250px; text-align: center;
            transition: all 0.3s ease;
        }
        .status-ok { color: #27ae60; border: 1px solid #2ecc71; }
        .status-alert { color: white; background: #f39c12 !important; border: 1px solid #e67e22; animation: blink 1s infinite; }
        .status-error { color: white; background: #e74c3c !important; border: 1px solid #c0392b; }

        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }

        .map-controls { position: absolute; bottom: 30px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 12px; }
        .control-btn {
            background: white; border: none; border-radius: 50%;
            width: 55px; height: 55px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        #recenter-navette.active { background: #3388ff; }
        #recenter-navette.active img { filter: invert(1); }
        .control-btn img { width: 26px; }
        
        .user-location-dot { width: 12px; height: 12px; background: #2196F3; border: 2px solid white; border-radius: 50%; box-shadow: 0 0 5px rgba(0,0,0,0.5); }
        .dot { height: 12px; width: 12px; background-color: #2ecc71; border-radius: 50%; }
        .pulse { animation: pulse-green 2s infinite; }
        @keyframes pulse-green {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(46, 204, 113, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); }
        }
    </style>
</head>
<body>

    <div class="status-header">
        <div class="status-top">
            <div id="status-dot" class="dot pulse"></div>
            <span id="status-text" style="font-weight: bold; color: #2c3e50; font-size: 11px; text-transform: uppercase;">NAVETTE EN DIRECT</span>
            <span id="current-time" class="status-time">--:--</span>
            <div id="weather-box"><span id="weather-temp">--°C</span><img id="weather-icon" src="" style="display: none;"></div>
        </div>
        <div id="current-date" class="status-date">Chargement...</div>
    </div>

    <div id="connection-banner" class="status-sub-header status-ok">
        VITESSE : <span id="speed-val">0</span> km/h
    </div>

    <div class="map-controls">
        <button class="control-btn" onclick="clearRoute()" title="Effacer le tracé" style="background: #e74c3c;">
            <img src="https://cdn-icons-png.flaticon.com/512/484/484611.png" style="filter: invert(1);">
        </button>
        <button class="control-btn" onclick="recenterUser()" title="Ma position">
            <img src="https://cdn-icons-png.flaticon.com/512/9431/9431114.png">
        </button>
        <button class="control-btn active" id="recenter-navette" onclick="toggleAutoCenter()" title="Suivre Navette">
            <img src="https://cdn-icons-png.flaticon.com/512/2838/2838912.png">
        </button>
    </div>

    <div id="map"></div>

    <script>
        // --- CONFIGURATION ---
        const TRACCAR_URL = 'http://192.168.1.60:8082';
        const DEVICE_ID = '1';
        const AUTH = 'Basic ' + btoa('lobby@hotel.local:Hotel2026!');
        const PROXIMITY_RADIUS = 100; 

        let autoCenter = true; 
        const alertSound = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
        let isAlertActive = false;

        // --- INITIALISATION CARTE ---
        const map = L.map('map', { zoomControl: false }).setView([45.8590, 6.6285], 16);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

        // Détection interaction pour stopper le suivi
        map.on('mousedown touchstart', () => {
            autoCenter = false;
            updateBtnStyle();
        });

        function updateBtnStyle() {
            const btn = document.getElementById('recenter-navette');
            if(autoCenter) btn.classList.add('active');
            else btn.classList.remove('active');
        }

        function toggleAutoCenter() {
            autoCenter = !autoCenter;
            if (autoCenter && lastNavLatLng) map.flyTo(lastNavLatLng, 17);
            updateBtnStyle();
        }

        let userMarker;
        map.locate({watch: true, enableHighAccuracy: true});
        map.on('locationfound', (e) => {
            if (!userMarker) userMarker = L.marker(e.latlng, { icon: L.divIcon({className: 'user-location-dot'}) }).addTo(map);
            else userMarker.setLatLng(e.latlng);
        });

        // --- NOUVEAU TRACÉ GEOJSON INTÉGRÉ ---
        const circuitData = {"type":"FeatureCollection","features":[{"type":"Feature","properties":{},"geometry":{"coordinates":[[6.629327231758907,45.85922782998932],[6.629352694096667,45.85913916704882],[6.629369668988801,45.85905937028127],[6.6293611815422935,45.85897070707276],[6.629314500590482,45.858899776403774],[6.629255088469279,45.85884362289295],[6.629153239119091,45.858796335682314],[6.629030171153971,45.85875495933976],[6.628877397129116,45.85869289476898],[6.628690673319994,45.85861900828442],[6.62846151228274,45.858521477973824],[6.628291763364814,45.85844759126152],[6.628192426129971,45.85840357963127],[6.62805238327357,45.858371069421196],[6.627895365525006,45.85834151466824],[6.627708641716794,45.85830604894343],[6.627564355136684,45.858276494155916],[6.627428556003082,45.85823807290819],[6.627330950375722,45.85818191872974],[6.627224857302707,45.85813463095636],[6.627135739121883,45.85808143216275],[6.62700418371108,45.85804892176432],[6.626842922239689,45.858051877255804],[6.626753804057984,45.85810212058843],[6.626707123106115,45.85818782969844],[6.62676653522729,45.85826171675592],[6.6268896031915006,45.85835333657107],[6.627059352108546,45.858492243744735],[6.627190907519321,45.858595685031304],[6.627313975484469,45.85870799249642],[6.6273988499424945,45.85877892341003],[6.627564526437482,45.858894418255574],[6.627747006523862,45.85895648260208],[6.627937974055783,45.859003769676576],[6.628044067128798,45.859062878462794],[6.628073773189385,45.859151541524966],[6.6279824475317355,45.859270487640146],[6.627848037516401,45.859299312980596],[6.627689844704349,45.85926900905402],[6.627551795269085,45.85923429358826],[6.62755023335302,45.85923452788592],[6.627690794614068,45.859269179616234]],"type":"LineString"}},{"type":"Feature","properties":{},"geometry":{"coordinates":[[6.627548150269092,45.85923247434408],[6.627420903006538,45.85920184095488],[6.627279517159224,45.85916464324495],[6.627136560356433,45.85913182171544],[6.627029735493835,45.859094623958214],[6.626914888643199,45.85904381309129],[6.626844195719542,45.85899239257452],[6.626771931841773,45.85893440767964],[6.626679245563906,45.858842506967875],[6.626603839779108,45.85875826451536],[6.626543973855377,45.85869751750744],[6.626459142346988,45.85863625012229],[6.626391591330275,45.858611086712244],[6.626276911698284,45.858611086712244],[6.626162232066292,45.85863843824427],[6.626118245357958,45.85868001254704],[6.626099393912057,45.858734715529835],[6.62611981631207,45.85802547153914],[6.626159090158012,45.85886381435631],[6.626226736483801,45.85894974787138],[6.626410538085281,45.85912698448067],[6.626514221040907,45.85924076570967],[6.626628619112495,45.85936496620113],[6.626854836469533,45.85963957124912],[6.626931207309752,45.859732100272026],[6.627108725097287,45.859871043114424],[6.627223404729335,45.85996075405632],[6.627287795810673,45.86001927812379],[6.62734906301074,45.86031247842084],[6.627406484847626,45.860568056239686],[6.627437903925369,45.860757321904686],[6.627438068228344,45.86086950257331],[6.627243269949105,45.86071852800691],[6.627041279242206,45.860568779890684],[6.626892038625442,45.86046047150495],[6.6268024942545765,45.860391547877214],[6.626624976468378,45.860300743601925],[6.626280144735688,45.860223943709],[6.62602879211758,45.860097036105174],[6.625848551113336,45.859928766233395],[6.625663178557659,45.859770130841355],[6.62553593129374,45.85966400898158],[6.62542910643117,45.85958414394338],[6.625207648847862,45.85942489826962],[6.62508982730759,45.85936144359198],[6.62487460662831,45.85924656856071],[6.624751957571448,45.85916886801169],[6.624640419847736,45.85909119036651],[6.624519456400435,45.85900476018324],[6.624406347721219,45.85891832986519],[6.624299998574742,45.8588335531297],[6.6241900318051705,45.85875368689864],[6.624073781219039,45.85865959776663],[6.6239669563564405,45.858588483782626],[6.623808461593001,45.85848532673151],[6.623778613469398,45.858472197961504]],"type":"LineString"}},{"type":"Feature","properties":{},"geometry":{"coordinates":[[6.623778657960088,45.85847247358757],[6.6237333956822795,45.85845881398865],[6.62362090857107,45.85842724712876],[6.623050619327245,45.85826218995291],[6.622379889849839,45.85800429768253],[6.621883282973641,45.8578084014558],[6.62163471261448,45.85774781971975],[6.621431548072479,45.85770759852747],[6.620984426637278,45.85761511043006],[6.620894851655152,45.857612647911026],[6.620851537388035,45.85764137738647],[6.620803066659533,45.85764999622583],[6.620758721099236,45.857639940912804],[6.620730876212832,45.8576155208591],[6.620729844920589,45.85758822784592],[6.6207484081781445,45.85756237129448],[6.620736262270157,45.857527804213845],[6.620658915362952,45.857497638203],[6.6205640364904355,45.857467472175756],[6.620650665026432,45.857494765248845],[6.620737293561575,45.857529240689786],[6.6207991710871,45.85753355011866],[6.620860017320439,45.85754504192647],[6.620889924791356,45.85757377143685],[6.620898175127877,45.85759316384758],[6.620970365574493,45.857613992725334]],"type":"LineString"}},{"type":"Feature","properties":{},"geometry":{"coordinates":[[6.631599319163371,45.853848541110295],[6.63155396307053,45.85415391134288],[6.631526749415372,45.854377146451554],[6.631499896447366,45.854677504390196],[6.631460587833345,45.85495338656102],[6.631436397918208,45.85517030058901],[6.631418255481833,45.855395637567],[6.631392340554072,45.8556605640446],[6.631368150637655,45.85589432275603],[6.631343960722489,45.856069114664194],[6.631304652108469,45.8563344603659],[6.631256635311445,45.85666949016442],[6.631214302958654,45.85693062121982],[6.6311719706058625,45.857162268710596],[6.6311275201990725,45.857444860820834],[6.631103330283935,45.85764491822408],[6.631103330283935,45.85794605590553],[6.63112674368503,45.85820803000945],[6.631163028559001,45.85847336550435],[6.631202337171771,45.85867552503228],[6.631247931735629,45.85886587488193],[6.631296311567155,45.859061715553]],"type":"LineString"}},{"type":"Feature","properties":{},"geometry":{"coordinates":[[6.63129535218701,45.85906163788184],[6.631280425976598,45.859170785239485],[6.631238446011054,45.85928253112169],[6.631196466045537,45.85934230208298],[6.630950491365638,45.85960617718976],[6.630607510155897,45.859949535365644],[6.630270118923534,45.860260161258736],[6.630106666941117,45.86044676703136],[6.630039678423657,45.86057179254837],[6.630024223075623,45.860687192406914],[6.630037620779348,45.86076929839351],[6.630101929756705,45.86084394009413],[6.630257343116682,45.86096336660671],[6.630560131216384,45.861179826506685],[6.63071554457747,45.86130858242706],[6.6308076419525435,45.861442961230324],[6.6310059279648215,45.86181803021799],[6.63112871475434,45.86206940110915],[6.63116086924299,45.8622280108944],[6.63116086924299,45.86240154814064],[6.631176946487926,45.86255082705907],[6.63120910097544,45.86266092000483],[6.631349368245736,45.86279959839294],[6.631544974716832,45.8629973914577],[6.631745940269184,45.8631578645591],[6.631885276385361,45.86328661589823],[6.631956680084585,45.86338682381006],[6.63201027089832,45.86354729578696],[6.632047784468313,45.863829053603496],[6.632101375283128,45.863991390239875],[6.632312064542418,45.86414619199192],[6.632563941368403,45.8643570417309],[6.632660404833331,45.8644503378201],[6.632731168653834,45.864674586000916],[6.632827632118762,45.864952606297265],[6.632996443183572,45.865120537346115],[6.633118473224556,45.86528139753153],[6.633327477399405,45.86539335095861],[6.633480211219279,45.86548477942324],[6.633651701824107,45.865602330085494],[6.633697254016539,45.86567509941855],[6.633683856312871,45.86575160040945],[6.633606149632811,45.86583369891696],[6.6334989680042895,45.8658672846349],[6.633373029591837,45.865882211614206],[6.6332578093407335,45.8658672846349],[6.633137230009538,45.86582810129505],[6.633008612055903,45.865777722675034],[6.632917507672204,45.86570681935436],[6.632764773852301,45.86557993950217],[6.632555769677452,45.86540268040042],[6.6322566689090365,45.86513001574454],[6.632154846362766,45.86505164799826],[6.63205838289781,45.86496581653017],[6.63195120126926,45.86487438721201],[6.631747556175668,45.86463368481819],[6.631380319762002,45.864234117015855],[6.631316010785696,45.86415761393667],[6.631235624564567,45.86406804922234],[6.6311713155882615,45.86400274152692],[6.630760799201624,45.863770513127946],[6.630441933858094,45.863589516358644],[6.630232929683245,45.863423446639615],[6.62994610358345,45.863199029847294],[6.629704944919894,45.86300870137504],[6.62957096788503,45.8629042070348],[6.629466465797606,45.862822104200944],[6.629378040953952,45.86271947548872],[6.629313171755626,45.86256120664629],[6.6292542218605774,45.86238953588736],[6.6292006310457054,45.86226264846434],[6.629117565284531,45.86214695673772],[6.629034499522135,45.862048058780516],[6.628908561109711,45.86190251052358],[6.628805581896529,45.86182207517811],[6.6284411643605665,45.86160748379413],[6.628151773965726,45.8614152838513],[6.627921999785286,45.86123340083907],[6.6276835206618046,45.861057993912254],[6.627490037449121,45.860911732587454],[6.62743816066552,45.86086942298249]],"type":"LineString"}]};

        // --- AJOUT DES HÔTELS EN POINTS ---
        const hotelsData = [
            { "name": "La Mamie", "icon": "images/logomamiemegeve.png", "coords": [45.8593, 6.6291] },
            { "name": "Mont d'Arbois", "icon": "images/logomontdarbois.png", "coords": [45.8538, 6.6317] },
            { "name": "L'Arboisie", "icon": "images/logolarboisie.png", "coords": [45.8586, 6.6276] }
        ];

        // Affichage du circuit (lignes bleues)
        L.geoJSON(circuitData, {
            style: { color: '#3388ff', weight: 5, opacity: 0.5 }
        }).addTo(map);

        // Affichage des hôtels
        hotelsData.forEach(h => {
            L.marker(h.coords, { 
                icon: L.icon({ iconUrl: h.icon, iconSize: [80, 80], iconAnchor: [40, 80] }) 
            }).addTo(map);
        });

        // --- LOGIQUE NAVETTE ---
        let navetteMarker, lastNavLatLng, routePath = [];
        let routeLine = L.polyline([], {color: '#2ecc71', weight: 3, opacity: 0.7, dashArray: '5, 10'}).addTo(map);

        function recenterUser() { if (userMarker) map.flyTo(userMarker.getLatLng(), 17); }
        function clearRoute() { if (confirm("Effacer le tracé ?")) { routePath = []; routeLine.setLatLngs([]); } }
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        async function updatePosition() {
            const banner = document.getElementById('connection-banner');
            try {
                const res = await fetch(`${TRACCAR_URL}/api/positions?deviceId=${DEVICE_ID}`, { headers: { 'Authorization': AUTH } });
                const positions = await res.json();
                if (positions.length > 0) {
                    const p = positions[0];
                    const newPos = [p.latitude, p.longitude];
                    const speedKmH = Math.round(p.speed * 1.852);

                    if (!lastNavLatLng || lastNavLatLng[0] !== newPos[0]) {
                        lastNavLatLng = newPos;
                        routePath.push(newPos);
                        if (routePath.length > 100) routePath.shift();
                        routeLine.setLatLngs(routePath);
                    }

                    if (autoCenter) map.panTo(newPos, { animate: true, duration: 1.5 });

                    // Alertes Proximité
                    let alertText = `VITESSE : ${speedKmH} km/h`;
                    let inZone = false;
                    hotelsData.forEach(h => {
                        if (getDistance(newPos[0], newPos[1], h.coords[0], h.coords[1]) < PROXIMITY_RADIUS) {
                            alertText = `⚠️ ARRIVÉE IMMINENTE : ${h.name.toUpperCase()}`;
                            inZone = true;
                        }
                    });

                    if (inZone && !isAlertActive) {
                        alertSound.play().catch(() => {});
                        isAlertActive = true;
                    } else if (!inZone) isAlertActive = false;

                    banner.innerHTML = alertText;
                    banner.className = inZone ? "status-sub-header status-alert" : "status-sub-header status-ok";

                    // Marqueur Navette
                    const label = `<b>NAVETTE MEGÈVE</b><br>${speedKmH} km/h`;
                    if (!navetteMarker) {
                        navetteMarker = L.marker(newPos, { icon: L.icon({ iconUrl: 'images/logonavettebleu.png', iconSize: [90, 90], iconAnchor: [45, 90] }) }).addTo(map);
                        navetteMarker.bindTooltip(label, { permanent: true, direction: 'top', offset: [0, -45], className: 'navette-label' }).openTooltip();
                    } else {
                        navetteMarker.setLatLng(newPos);
                        navetteMarker.setTooltipContent(label);
                    }
                }
            } catch (e) { banner.className = "status-sub-header status-error"; banner.innerHTML = "ERREUR SERVEUR"; }
        }

        // --- FONCTIONS SECONDAIRES ---
        async function updateWeather() {
            try {
                const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=45.85&longitude=6.61&current_weather=true');
                const data = await res.json();
                document.getElementById('weather-temp').textContent = `${Math.round(data.current_weather.temperature)}°C`;
                const img = document.getElementById('weather-icon');
                img.src = "https://cdn-icons-png.flaticon.com/512/869/869869.png"; img.style.display = "block";
            } catch (e) {}
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('current-date').textContent = now.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });
            document.getElementById('current-time').textContent = now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
        }

        setInterval(updatePosition, 3000); setInterval(updateClock, 1000); setInterval(updateWeather, 1800000);
        updatePosition(); updateClock(); updateWeather();
    </script>
</body>
</html>

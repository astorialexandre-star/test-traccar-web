<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Live Map - Navette Megève</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        #map { height: 100vh; width: 100%; }
        body { margin: 0; padding: 0; overflow: hidden; background-color: #f4f4f4; }
        
        /* Animation fluide pour le mouvement de la navette */
        .leaflet-marker-icon {
            transition: transform 1.5s linear, left 1.5s linear, top 1.5s linear;
        }

        .navette-label {
            background: rgba(44, 62, 80, 0.9);
            color: white;
            border: 1px solid white;
            border-radius: 4px;
            padding: 2px 8px;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        .status-header {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%); 
            z-index: 1000; background: rgba(255,255,255,0.95); 
            padding: 10px 15px; border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
            font-family: sans-serif; display: flex; flex-direction: column; align-items: center;
            width: 90%; max-width: 550px; text-align: center;
        }
        .status-top { display: flex; align-items: center; width: 100%; justify-content: center; margin-bottom: 4px; gap: 10px; }
        .status-time { font-size: 18px; font-weight: bold; color: #2c3e50; min-width: 60px; }
        .status-date { font-size: 11px; text-transform: uppercase; opacity: 0.7; color: #2c3e50; }
        #weather-box { display: flex; align-items: center; border-left: 1px solid #ddd; padding-left: 10px; margin-left: 5px; }
        #weather-temp { font-weight: bold; font-size: 16px; color: #2c3e50; }
        #weather-icon { width: 28px; height: 28px; margin-left: 5px; }

        .status-sub-header {
            position: absolute; top: 80px; left: 50%; transform: translateX(-50%); 
            z-index: 1000; background: rgba(255,255,255,0.9); 
            padding: 5px 15px; border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            font-family: sans-serif; font-size: 13px; font-weight: bold;
            width: auto; min-width: 250px; text-align: center;
            transition: all 0.3s ease;
        }
        .status-ok { color: #27ae60; border: 1px solid #2ecc71; }
        .status-alert { color: white; background: #f39c12 !important; border: 1px solid #e67e22; animation: blink 1s infinite; }
        .status-error { color: white; background: #e74c3c !important; border: 1px solid #c0392b; }

        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }

        .map-controls { position: absolute; bottom: 30px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 12px; }
        .control-btn {
            background: white; border: none; border-radius: 50%;
            width: 55px; height: 55px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        #recenter-navette.active { background: #3388ff; }
        #recenter-navette.active img { filter: invert(1); }
        .control-btn img { width: 26px; }
        
        .user-location-dot { width: 12px; height: 12px; background: #2196F3; border: 2px solid white; border-radius: 50%; box-shadow: 0 0 5px rgba(0,0,0,0.5); }
        .dot { height: 12px; width: 12px; background-color: #2ecc71; border-radius: 50%; }
        .pulse { animation: pulse-green 2s infinite; }
        @keyframes pulse-green {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(46, 204, 113, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); }
        }
    </style>
</head>
<body>

    <div class="status-header">
        <div class="status-top">
            <div id="status-dot" class="dot pulse"></div>
            <span id="status-text" style="font-weight: bold; color: #2c3e50; font-size: 11px; text-transform: uppercase;">NAVETTE EN DIRECT</span>
            <span id="current-time" class="status-time">--:--</span>
            <div id="weather-box"><span id="weather-temp">--°C</span><img id="weather-icon" src="" style="display: none;"></div>
        </div>
        <div id="current-date" class="status-date">Chargement...</div>
    </div>

    <div id="connection-banner" class="status-sub-header status-ok">
        VITESSE : <span id="speed-val">0</span> km/h
    </div>

    <div class="map-controls">
        <button class="control-btn" onclick="clearRoute()" title="Effacer le tracé" style="background: #e74c3c;">
            <img src="https://cdn-icons-png.flaticon.com/512/484/484611.png" style="filter: invert(1);">
        </button>
        <button class="control-btn" onclick="recenterUser()" title="Ma position">
            <img src="https://cdn-icons-png.flaticon.com/512/9431/9431114.png">
        </button>
        <button class="control-btn active" id="recenter-navette" onclick="toggleAutoCenter()" title="Suivre Navette">
            <img src="https://cdn-icons-png.flaticon.com/512/2838/2838912.png">
        </button>
    </div>

    <div id="map"></div>

    <script>
        // --- CONFIGURATION ---
        const TRACCAR_URL = 'http://192.168.1.60:8082';
        const DEVICE_ID = '1';
        const AUTH = 'Basic ' + btoa('lobby@hotel.local:Hotel2026!');
        const PROXIMITY_RADIUS = 100; // Alerte à 100 mètres

        let autoCenter = true; // Mode suivi activé par défaut
        const alertSound = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
        let isAlertActive = false;

        // --- INITIALISATION CARTE ---
        const map = L.map('map', { zoomControl: false }).setView([45.8590, 6.6285], 16);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

        // Désactiver le suivi auto si l'utilisateur déplace la carte manuellement
        map.on('movestart', (e) => {
            if (e.hard) return; // Ignore si c'est un mouvement généré par le code
            autoCenter = false;
            updateBtnStyle();
        });

        function updateBtnStyle() {
            const btn = document.getElementById('recenter-navette');
            if(autoCenter) btn.classList.add('active');
            else btn.classList.remove('active');
        }

        function toggleAutoCenter() {
            autoCenter = !autoCenter;
            if (autoCenter && lastNavLatLng) map.flyTo(lastNavLatLng, 17);
            updateBtnStyle();
        }

        let userMarker;
        map.locate({watch: true, enableHighAccuracy: true});
        map.on('locationfound', (e) => {
            if (!userMarker) userMarker = L.marker(e.latlng, { icon: L.divIcon({className: 'user-location-dot'}) }).addTo(map);
            else userMarker.setLatLng(e.latlng);
        });

        // --- HÔTELS & CIRCUIT ---
        const circuitData = {
            "type": "FeatureCollection",
            "features": [
                { "type": "Feature", "geometry": { "type": "LineString", "coordinates": [[6.6293,45.8592],[6.6293,45.8590],[6.6293,45.8588],[6.6290,45.8587],[6.6280,45.8583],[6.6271,45.8581],[6.6267,45.8581],[6.6267,45.8582],[6.6269,45.8583],[6.6271,45.8585],[6.6273,45.8587],[6.6279,45.8589],[6.6280,45.8590],[6.6280,45.8592],[6.6278,45.8592],[6.6270,45.8591],[6.6268,45.8589],[6.6264,45.8586],[6.6261,45.8586],[6.6261,45.8588],[6.6267,45.8595],[6.6270,45.8598],[6.6272,45.8599],[6.6273,45.8602],[6.6274,45.8608],[6.6271,45.8606],[6.6268,45.8603],[6.6263,45.8602],[6.6256,45.8598],[6.6250,45.8593],[6.6243,45.8589],[6.6237,45.8584],[6.6225,45.8580],[6.6210,45.8576],[6.6207,45.8576]] } },
                { "type": "Feature", "properties": { "name": "La Mamie", "icon": "images/logomamiemegeve.png" }, "geometry": { "type": "Point", "coordinates": [6.6291, 45.8593] } },
                { "type": "Feature", "properties": { "name": "Mont d'Arbois", "icon": "images/logomontdarbois.png" }, "geometry": { "type": "Point", "coordinates": [6.6317, 45.8538] } },
                { "type": "Feature", "properties": { "name": "L'Arboisie", "icon": "images/logolarboisie.png" }, "geometry": { "type": "Point", "coordinates": [6.6276, 45.8586] } }
            ]
        };

        L.geoJSON(circuitData, {
            style: { color: '#3388ff', weight: 5, opacity: 0.4 },
            pointToLayer: (f, latlng) => L.marker(latlng, { icon: L.icon({ iconUrl: f.properties.icon, iconSize: [80, 80], iconAnchor: [40, 80] }) })
        }).addTo(map);

        // --- LOGIQUE NAVETTE ---
        let navetteMarker, lastNavLatLng, routePath = [];
        let routeLine = L.polyline([], {color: '#2ecc71', weight: 3, opacity: 0.7, dashArray: '5, 10'}).addTo(map);

        function recenterUser() { if (userMarker) map.flyTo(userMarker.getLatLng(), 17); }
        function clearRoute() { if (confirm("Effacer le tracé ?")) { routePath = []; routeLine.setLatLngs([]); } }
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        async function updatePosition() {
            const banner = document.getElementById('connection-banner');
            try {
                const res = await fetch(`${TRACCAR_URL}/api/positions?deviceId=${DEVICE_ID}`, { headers: { 'Authorization': AUTH } });
                const positions = await res.json();
                if (positions.length > 0) {
                    const p = positions[0];
                    const newPos = [p.latitude, p.longitude];
                    const speedKmH = Math.round(p.speed * 1.852);

                    if (!lastNavLatLng || lastNavLatLng[0] !== newPos[0]) {
                        lastNavLatLng = newPos;
                        routePath.push(newPos);
                        if (routePath.length > 100) routePath.shift();
                        routeLine.setLatLngs(routePath);
                    }

                    // Suivi automatique
                    if (autoCenter) {
                        map.panTo(newPos, { animate: true, duration: 1.5, hard: true });
                    }

                    // Alertes Proximité & Son
                    let alertText = `VITESSE : ${speedKmH} km/h`;
                    let inZone = false;
                    circuitData.features.forEach(f => {
                        if (f.geometry.type === "Point") {
                            if (getDistance(newPos[0], newPos[1], f.geometry.coordinates[1], f.geometry.coordinates[0]) < PROXIMITY_RADIUS) {
                                alertText = `⚠️ ARRIVÉE IMMINENTE : ${f.properties.name.toUpperCase()}`;
                                inZone = true;
                            }
                        }
                    });

                    if (inZone && !isAlertActive) {
                        alertSound.play().catch(() => {});
                        isAlertActive = true;
                    } else if (!inZone) isAlertActive = false;

                    banner.innerHTML = alertText;
                    banner.className = inZone ? "status-sub-header status-alert" : "status-sub-header status-ok";

                    // Marqueur
                    const label = `<b>NAVETTE MEGÈVE</b><br>${speedKmH} km/h`;
                    if (!navetteMarker) {
                        navetteMarker = L.marker(newPos, { icon: L.icon({ iconUrl: 'images/logonavettebleu.png', iconSize: [90, 90], iconAnchor: [45, 90] }) }).addTo(map);
                        navetteMarker.bindTooltip(label, { permanent: true, direction: 'top', offset: [0, -45], className: 'navette-label' }).openTooltip();
                    } else {
                        navetteMarker.setLatLng(newPos);
                        navetteMarker.setTooltipContent(label);
                    }
                }
            } catch (e) { banner.className = "status-sub-header status-error"; banner.innerHTML = "ERREUR SERVEUR"; }
        }

        // --- FONCTIONS SECONDAIRES ---
        async function updateWeather() {
            try {
                const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=45.85&longitude=6.61&current_weather=true');
                const data = await res.json();
                document.getElementById('weather-temp').textContent = `${Math.round(data.current_weather.temperature)}°C`;
                const img = document.getElementById('weather-icon');
                img.src = "https://cdn-icons-png.flaticon.com/512/869/869869.png"; img.style.display = "block";
            } catch (e) {}
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('current-date').textContent = now.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });
            document.getElementById('current-time').textContent = now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
        }

        setInterval(updatePosition, 3000); setInterval(updateClock, 1000); setInterval(updateWeather, 1800000);
        updatePosition(); updateClock(); updateWeather();
    </script>
</body>
</html>

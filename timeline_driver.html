<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>369 - Audit des Rotations</title>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
        :root { --primary: #005587; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 15px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .filter-bar { display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #eee; }
        .filter-group { display: flex; flex-direction: column; gap: 5px; }
        label { font-size: 11px; font-weight: bold; color: var(--primary); text-transform: uppercase; }
        input, select { padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px; }
        .btn-refresh { background: var(--primary); color: white; border: none; padding: 9px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        #chart_div { width: 100%; min-height: 450px; }
        #status-msg { font-size: 12px; color: #666; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="color:var(--primary); margin: 0 0 15px 0;">üóìÔ∏è AUDIT DES ROTATIONS</h2>
    
    <div class="filter-bar">
        <div class="filter-group"><label>Navette</label><select id="shuttle-filter"><option value="all">-- Toutes --</option></select></div>
        <div class="filter-group"><label>Date</label><input type="date" id="target-date"></div>
        <div class="filter-group"><label>Heures</label><div style="display:flex; gap:5px;">
            <input type="time" id="start-time" value="06:00"> √† <input type="time" id="end-time" value="23:30">
        </div></div>
        <button class="btn-refresh" onclick="drawChart()">Lancer l'Audit</button>
    </div>

    <div id="chart_div"></div>
    <div id="status-msg"></div>
</div>

<script>
    const TRACCAR_URL = 'https://369shuttles.duckdns.org';
    const AUTH = 'Basic ' + btoa('lobby@hotel.local:Hotel2026!');
    
    google.charts.load('current', {'packages':['timeline'], 'language': 'fr'});
    
    window.onload = async () => {
        document.getElementById('target-date').valueAsDate = new Date();
        await populateShuttles();
        drawChart();
    };

    async function populateShuttles() {
        const res = await fetch(`${TRACCAR_URL}/api/devices`, { headers: { 'Authorization': AUTH } });
        const devices = await res.json();
        const select = document.getElementById('shuttle-filter');
        devices.sort((a,b) => a.name.localeCompare(b.name)).forEach(d => {
            const opt = document.createElement('option');
            opt.value = d.id; opt.textContent = d.name;
            select.appendChild(opt);
        });
    }

    async function drawChart() {
        const container = document.getElementById('chart_div');
        const status = document.getElementById('status-msg');
        const dateStr = document.getElementById('target-date').value;
        const startH = document.getElementById('start-time').value;
        const endH = document.getElementById('end-time').value;
        const selectedId = document.getElementById('shuttle-filter').value;

        container.innerHTML = "Scan des positions en cours...";

        try {
            const from = new Date(`${dateStr}T${startH}:00`).toISOString();
            const to = new Date(`${dateStr}T${endH}:00`).toISOString();

            // On r√©cup√®re tout ce qu'on peut
            const [resDev, resPos] = await Promise.all([
                fetch(`${TRACCAR_URL}/api/devices`, { headers: { 'Authorization': AUTH } }),
                fetch(`${TRACCAR_URL}/api/positions?from=${from}&to=${to}`, { headers: { 'Authorization': AUTH } })
            ]);

            const devices = await resDev.json();
            const positions = await resPos.json();

            status.innerHTML = `Analyse de ${positions.length} points GPS...`;

            const dataTable = new google.visualization.DataTable();
            dataTable.addColumn({ type: 'string', id: 'Navette' });
            dataTable.addColumn({ type: 'string', id: 'Chauffeur' });
            dataTable.addColumn({ type: 'string', role: 'style' });
            dataTable.addColumn({ type: 'date', id: 'D√©but' });
            dataTable.addColumn({ type: 'date', id: 'Fin' });

            const rows = [];

            devices.forEach(dev => {
                if (selectedId !== "all" && dev.id != selectedId) return;

                // On filtre les positions de CETTE navette
                const devPos = positions.filter(p => p.deviceId === dev.id).sort((a,b) => new Date(a.deviceTime) - new Date(b.deviceTime));
                
                let currentDriver = null;
                let startTime = null;

                devPos.forEach((p, index) => {
                    // FORCE CHECK : On regarde partout o√π le chauffeur pourrait √™tre cach√©
                    let driverAtPos = p.attributes.currentDriver || p.attributes.driverName || p.attributes.chauffeur;
                    
                    // Si on ne trouve rien dans la position, on regarde si le Device a un chauffeur actuellement
                    // et on l'applique aux points r√©cents (derni√®re heure)
                    if (!driverAtPos && dev.attributes.currentDriver) {
                        const posTime = new Date(p.deviceTime);
                        const now = new Date();
                        if (now - posTime < 3600000) driverAtPos = dev.attributes.currentDriver;
                    }

                    if (driverAtPos !== currentDriver) {
                        if (currentDriver && currentDriver !== "Aucun chauffeur") {
                            rows.push([dev.name, currentDriver, getColor(dev), startTime, new Date(p.deviceTime)]);
                        }
                        currentDriver = driverAtPos;
                        startTime = new Date(p.deviceTime);
                    }
                    
                    if (index === devPos.length - 1 && currentDriver && currentDriver !== "Aucun chauffeur") {
                        rows.push([dev.name, currentDriver, getColor(dev), startTime, new Date(p.deviceTime)]);
                    }
                });
            });

            if (rows.length === 0) {
                container.innerHTML = "Aucune session chauffeur d√©tect√©e. <br><small>V√©rifiez que l'app chauffeur envoie bien le nom dans les attributs de position.</small>";
                return;
            }

            const chart = new google.visualization.Timeline(container);
            chart.draw(dataTable, {
                timeline: { showRowLabels: true, groupByRowLabel: true },
                hAxis: { format: 'HH:mm' }
            });
            status.innerHTML = "Audit termin√© avec succ√®s.";

        } catch (e) { container.innerHTML = "Erreur : " + e.message; }
    }

    function getColor(dev) {
        const line = dev.attributes.assignedLine || "";
        if (line.includes("1")) return "#3498db";
        if (line.includes("2")) return "#9b59b6";
        if (line.includes("3")) return "#e67e22";
        return "#bdc3c7";
    }
</script>
</body>
</html>

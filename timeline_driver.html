<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>369 - Audit Final</title>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
        :root { --primary: #005587; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .filter-bar { display: flex; gap: 10px; background: #eee; padding: 15px; border-radius: 8px; margin-bottom: 20px; align-items: flex-end; }
        #chart_div { width: 100%; min-height: 400px; border: 1px solid #ddd; }
        .debug-box { background: #333; color: #0f0; padding: 10px; font-family: monospace; font-size: 11px; margin-top: 10px; max-height: 150px; overflow-y: auto; }
    </style>
</head>
<body>

<div class="container">
    <h2>üìä Audit des Rotations v7</h2>
    <div class="filter-bar">
        <div><label>Date</label><br><input type="date" id="date-pick"></div>
        <button onclick="runAudit()" style="background:var(--primary); color:white; border:none; padding:10px 20px; cursor:pointer;">Lancer l'Audit</button>
    </div>
    <div id="chart_div"></div>
    <div id="debug" class="debug-box">Pr√™t pour l'analyse...</div>
</div>

<script>
    const TRACCAR_URL = 'https://369shuttles.duckdns.org';
    const AUTH = 'Basic ' + btoa('lobby@hotel.local:Hotel2026!');
    google.charts.load('current', {'packages':['timeline'], 'language': 'fr'});

    document.getElementById('date-pick').valueAsDate = new Date();

    async function runAudit() {
        const date = document.getElementById('date-pick').value;
        const debug = document.getElementById('debug');
        debug.innerHTML = "D√©marrage de l'analyse...";

        try {
            // 1. R√©cup√©ration des donn√©es
            const [resDev, resDriv, resPos] = await Promise.all([
                fetch(`${TRACCAR_URL}/api/devices`, { headers: { 'Authorization': AUTH } }),
                fetch(`${TRACCAR_URL}/api/drivers`, { headers: { 'Authorization': AUTH } }),
                fetch(`${TRACCAR_URL}/api/positions?from=${date}T00:00:00Z&to=${date}T23:59:59Z`, { headers: { 'Authorization': AUTH } })
            ]);

            const devices = await resDev.json();
            const drivers = await resDriv.json();
            const positions = await resPos.json();

            debug.innerHTML += `<br>Points GPS : ${positions.length} | Chauffeurs enregistr√©s : ${drivers.length}`;

            const dataTable = new google.visualization.DataTable();
            dataTable.addColumn({ type: 'string', id: 'Navette' });
            dataTable.addColumn({ type: 'string', id: 'Chauffeur' });
            dataTable.addColumn({ type: 'date', id: 'D√©but' });
            dataTable.addColumn({ type: 'date', id: 'Fin' });

            const rows = [];

            devices.forEach(dev => {
                const devPos = positions.filter(p => p.deviceId === dev.id).sort((a,b) => new Date(a.deviceTime) - new Date(b.deviceTime));
                
                let currentDriverName = null;
                let startTime = null;

                devPos.forEach((p, index) => {
                    // On cherche le chauffeur par son ID Traccar si le nom n'est pas √©crit en clair
                    const dId = p.attributes.driverUniqueId || p.attributes.driverId;
                    let foundDriver = drivers.find(d => d.uniqueId == dId || d.id == dId);
                    
                    // Si toujours rien, on tente de lire le nom en clair
                    let name = foundDriver ? foundDriver.name : (p.attributes.currentDriver || p.attributes.driverName);

                    if (name !== currentDriverName) {
                        if (currentDriverName) {
                            rows.push([dev.name, currentDriverName, startTime, new Date(p.deviceTime)]);
                        }
                        currentDriverName = name;
                        startTime = new Date(p.deviceTime);
                    }
                    
                    if (index === devPos.length - 1 && currentDriverName) {
                        rows.push([dev.name, currentDriverName, startTime, new Date(p.deviceTime)]);
                    }
                });
            });

            if (rows.length === 0) {
                debug.innerHTML += "<br>‚ö†Ô∏è AUCUNE SESSION TROUV√âE. V√©rification des attributs...";
                if (positions.length > 0) {
                    debug.innerHTML += "<br>Exemple d'attributs sur le point 1 : " + JSON.stringify(positions[0].attributes);
                }
                return;
            }

            const chart = new google.visualization.Timeline(document.getElementById('chart_div'));
            chart.draw(dataTable);
            debug.innerHTML += "<br>‚úÖ Succ√®s !";

        } catch (e) { debug.innerHTML += "<br>‚ùå Erreur : " + e.message; }
    }
</script>
</body>
</html>

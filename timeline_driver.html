<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>369 - Planning Op√©rationnel</title>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
        :root { --primary: #005587; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        .controls { display: flex; gap: 10px; align-items: center; }
        input[type="date"] { padding: 8px; border: 1px solid #ddd; border-radius: 5px; }
        button { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        #chart_div { width: 100%; height: 500px; }
        .loading-overlay { display: none; text-align: center; padding: 50px; font-style: italic; color: #666; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2 style="color:var(--primary); margin:0;">üìä PLANNING DES ROTATIONS</h2>
        <div class="controls">
            <input type="date" id="target-date">
            <button onclick="drawChart()">Actualiser</button>
        </div>
    </div>

    <div id="loading" class="loading-overlay">Analyse des donn√©es Traccar en cours...</div>
    <div id="chart_div"></div>
</div>

<script>
    const TRACCAR_URL = 'https://369shuttles.duckdns.org';
    const AUTH = 'Basic ' + btoa('lobby@hotel.local:Hotel2026!');
    
    google.charts.load('current', {'packages':['timeline'], 'language': 'fr'});
    
    document.getElementById('target-date').valueAsDate = new Date();

    async function drawChart() {
        const dateStr = document.getElementById('target-date').value;
        const loader = document.getElementById('loading');
        const chartDiv = document.getElementById('chart_div');
        
        loader.style.display = 'block';
        chartDiv.style.opacity = '0.3';

        try {
            const [resDev, resPos] = await Promise.all([
                fetch(`${TRACCAR_URL}/api/devices`, { headers: { 'Authorization': AUTH } }),
                fetch(`${TRACCAR_URL}/api/positions?from=${dateStr}T00:00:00Z&to=${dateStr}T23:59:59Z`, { headers: { 'Authorization': AUTH } })
            ]);

            const devices = await resDev.json();
            const positions = await resPos.json();

            if (positions.length === 0) {
                alert("Aucune donn√©e pour cette journ√©e.");
                loader.style.display = 'none';
                return;
            }

            const container = document.getElementById('chart_div');
            const chart = new google.visualization.Timeline(container);
            const dataTable = new google.visualization.DataTable();

            dataTable.addColumn({ type: 'string', id: 'Navette' });
            dataTable.addColumn({ type: 'string', id: 'Chauffeur' });
            dataTable.addColumn({ type: 'date', id: 'D√©but' });
            dataTable.addColumn({ type: 'date', id: 'Fin' });

            const rows = [];
            
            // Groupement des positions par Navette
            const devIds = [...new Set(positions.map(p => p.deviceId))];

            devIds.forEach(dId => {
                const devName = devices.find(d => d.id === dId)?.name || `ID: ${dId}`;
                const devPos = positions.filter(p => p.deviceId === dId).sort((a,b) => new Date(a.deviceTime) - new Date(b.deviceTime));

                let currentDriver = null;
                let startTime = null;

                devPos.forEach((p, index) => {
                    const driverAtPos = p.attributes.currentDriver || "Sans Chauffeur";
                    const timeAtPos = new Date(p.deviceTime);

                    if (driverAtPos !== currentDriver) {
                        if (currentDriver !== null) {
                            rows.push([devName, currentDriver, startTime, timeAtPos]);
                        }
                        currentDriver = driverAtPos;
                        startTime = timeAtPos;
                    }
                    
                    // Si c'est le dernier point de la journ√©e pour cette navette
                    if (index === devPos.length - 1 && currentDriver !== null) {
                        rows.push([devName, currentDriver, startTime, timeAtPos]);
                    }
                });
            });

            dataTable.addRows(rows);

            const options = {
                timeline: { 
                    showRowLabels: true,
                    groupByRowLabel: true,
                    colorByRowLabel: false
                },
                avoidOverlappingGridLines: false
            };

            chart.draw(dataTable, options);
            loader.style.display = 'none';
            chartDiv.style.opacity = '1';

        } catch (e) {
            console.error(e);
            loader.innerHTML = "Erreur de chargement des donn√©es.";
        }
    }
</script>

</body>
</html>

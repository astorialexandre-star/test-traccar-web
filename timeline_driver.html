<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>LOGS - Timeline Chauffeurs</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        :root { --primary: #005587; --success: #2ecc71; --bg: #f4f7f6; --dark: #333; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--dark); }
        .container { max-width: 800px; margin: 0 auto; }
        .header-box { text-align: center; margin-bottom: 30px; }
        h1 { color: var(--primary); margin-bottom: 5px; }
        .controls { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; display: flex; gap: 15px; align-items: flex-end; justify-content: center; flex-wrap: wrap; }
        .control-group { display: flex; flex-direction: column; gap: 5px; }
        label { font-size: 11px; font-weight: bold; color: var(--primary); text-transform: uppercase; }
        input[type="date"], select { padding: 10px; border: 1px solid #ddd; border-radius: 6px; min-width: 180px; }
        button { background: var(--primary); color: white; border: none; padding: 11px 25px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .timeline { position: relative; padding: 20px 0; }
        .timeline::before { content: ''; position: absolute; left: 31px; top: 0; bottom: 0; width: 4px; background: #e0e6ed; }
        .event-card { position: relative; margin-bottom: 15px; padding-left: 60px; }
        .event-dot { position: absolute; left: 22px; top: 12px; width: 22px; height: 22px; background: var(--success); border: 4px solid white; border-radius: 50%; z-index: 2; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .event-content { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; border-left: 5px solid var(--primary); }
        .event-time { font-family: monospace; font-size: 14px; color: var(--primary); font-weight: bold; }
        .driver-name { font-size: 16px; font-weight: bold; }
        .shuttle-badge { font-size: 11px; background: #f0f4f8; padding: 4px 10px; border-radius: 20px; color: #555; font-weight: bold; }
        .loading { text-align: center; padding: 40px; color: #888; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-box">
        <h1>LOGISTIQUE 369</h1>
        <div class="subtitle">Analyse des sessions chauffeurs (via positions)</div>
    </div>
    
    <div class="controls">
        <div class="control-group">
            <label>Date</label>
            <input type="date" id="log-date">
        </div>
        <div class="control-group">
            <label>Navette</label>
            <select id="shuttle-select">
                <option value="">-- Choisir une navette --</option>
            </select>
        </div>
        <button onclick="fetchTimeline()">Analyser</button>
    </div>

    <div id="timeline-container" class="timeline">
        <div class="loading">S√©lectionnez une navette et une date pour lancer l'analyse.</div>
    </div>
</div>

<script>
    const TRACCAR_URL = 'https://369shuttles.duckdns.org';
    const AUTH = 'Basic ' + btoa('lobby@hotel.local:Hotel2026!');
    
    let allDevices = [];

    window.onload = async () => {
        document.getElementById('log-date').valueAsDate = new Date();
        await loadDevices();
    };

    async function loadDevices() {
        try {
            const res = await fetch(`${TRACCAR_URL}/api/devices`, { headers: { 'Authorization': AUTH } });
            allDevices = await res.json();
            const select = document.getElementById('shuttle-select');
            allDevices.sort((a,b) => a.name.localeCompare(b.name)).forEach(dev => {
                const opt = document.createElement('option');
                opt.value = dev.id;
                opt.textContent = dev.name;
                select.appendChild(opt);
            });
        } catch (e) { console.error(e); }
    }

    async function fetchTimeline() {
        const container = document.getElementById('timeline-container');
        const date = document.getElementById('log-date').value;
        const deviceId = document.getElementById('shuttle-select').value;
        
        if (!deviceId) { alert("S√©lectionnez une navette"); return; }
        
        container.innerHTML = '<div class="loading">Analyse approfondie des positions (ceci peut prendre 10s)...</div>';

        try {
            const from = new Date(date + "T00:00:00Z").toISOString();
            const to = new Date(date + "T23:59:59Z").toISOString();
            
            // On r√©cup√®re TOUTES les positions de la navette pour la journ√©e
            const resPos = await fetch(`${TRACCAR_URL}/api/positions?deviceId=${deviceId}&from=${from}&to=${to}`, {
                headers: { 'Authorization': AUTH }
            });
            const positions = await resPos.json();

            if (positions.length === 0) {
                container.innerHTML = '<div class="loading">Aucune donn√©e de position pour cette journ√©e.</div>';
                return;
            }

            // Algorithme de d√©tection de changement
            let history = [];
            let lastDriver = null;

            // On parcourt chronologiquement
            positions.sort((a, b) => new Date(a.deviceTime) - new Date(b.deviceTime));

            positions.forEach(pos => {
                const currentDriver = pos.attributes.currentDriver || "Aucun chauffeur";
                if (currentDriver !== lastDriver) {
                    history.push({
                        time: pos.deviceTime,
                        driver: currentDriver,
                        deviceName: allDevices.find(d => d.id == deviceId).name
                    });
                    lastDriver = currentDriver;
                }
            });

            // Affichage (plus r√©cent en haut)
            container.innerHTML = history.reverse().map(event => {
                const time = new Date(event.time).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                return `
                    <div class="event-card">
                        <div class="event-dot"></div>
                        <div class="event-content">
                            <div>
                                <div class="event-time">${time}</div>
                                <div class="driver-name">${event.driver}</div>
                            </div>
                            <div class="shuttle-badge">üöê ${event.deviceName}</div>
                        </div>
                    </div>
                `;
            }).join('');

        } catch (e) {
            container.innerHTML = '<div class="loading" style="color:red">Erreur lors de l\'analyse.</div>';
        }
    }
</script>

</body>
</html>
